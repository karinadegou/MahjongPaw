# 安装部署运行说明

## 一、环境要求

- 操作系统：Windows 10 / 11（推荐），支持 macOS / Linux
- Python：3.9
- 显卡：可选（YOLO 支持 CPU 推理；使用 GPU 需正确安装匹配 CUDA 的 PyTorch）

## 二、获取代码与准备

1. 克隆或下载项目到本地
2. 创建并启用虚拟环境（推荐）

```powershell
python -m venv .venv
. .venv\Scripts\activate
python -m pip install --upgrade pip
```

macOS / Linux：

```bash
python3 -m venv .venv
source .venv/bin/activate
python -m pip install --upgrade pip
```

## 三、安装依赖

使用项目根目录下的依赖文件：

```bash
pip install -r requirements.txt
```

如需 GPU 加速，请先安装匹配版本的 PyTorch（参考 PyTorch 官网安装指引），再安装其余依赖。

## 四、模型与资源准备

- YOLO 权重：确保存在目录 Mahjong_YOLO/trained_models_v2/，并包含至少一个权重文件（如 yolo11m_best.pt）
- 截图保存路径：Mahjong_YOLO/test.png（由 GUI 的“一键截图+分析+解说”自动生成）
- 识别可视化输出：Mahjong_YOLO/prediction_result.jpg（自动生成）

项目内含转换脚本（非必需）：
- Mahjong_YOLO/scripts/convert_yolo_to_onnx.py
- Mahjong_YOLO/scripts/convert_yolo_to_coreml.py

## 五、配置大模型 API Key

DeepSeek API Key 使用环境变量 DEEPSEEK_API_KEY：

Windows PowerShell：

```powershell
$env:DEEPSEEK_API_KEY = "你的密钥"
```

macOS / Linux：

```bash
export DEEPSEEK_API_KEY="你的密钥"
```

说明：
- GUI 中通过 api_gui.py 调用环境变量；未设置时将无法正常进行解说

## 六、运行方式

### 方式 A：桌面 GUI（推荐）

1. 启动 GUI：

```bash
python main.py
```

2. 在 GUI 中使用：
- 开始分析（流式输出）：读取 output.txt 并开始解说
- 一键截图 + 分析 + AI 解说：自动截图到 Mahjong_YOLO/test.png → YOLO 识别 → 写入 output.txt → 流式解说
- 清空结果：清空文本输出区域
- 聊天：在输入框发送消息，可连续追问分析

### 方式 B：命令行单次分析（可选）

1. 准备 Mahjong_YOLO/test.png（自行截图或使用其他工具）
2. 执行：

```bash
python analyzer.py
```

- 将自动调用 YOLO 识别并写入分析报告到 output.txt

## 七、功能热键（可选）

- main.py 包含 ScreenshotService/QuickScreenshot 示例，可注册 Ctrl+Alt+S 热键截图（默认入口为 GUI，不必使用此服务）
- 在 Windows 上使用热键服务可能需要管理员权限

## 八、验证

- 首次运行 GUI 后，点击“一键截图 + 分析 + AI 解说”
- 稍候将看到实时流式输出；Mahjong_YOLO/prediction_result.jpg 将生成识别可视化
- 若 output.txt 出现且有内容，说明识别与分析流程正常

## 九、常见问题

- output.txt 不存在  
  使用“一键截图 + 分析 + AI 解说”，或先运行 analyzer.run_analysis_to_file("output.txt") 生成。

- DeepSeek API 调用失败  
  检查 DEEPSEEK_API_KEY 是否设置正确；确认网络可用；稍后重试。

- YOLO 报错或推理速度慢  
  未安装 GPU 版本的 PyTorch 时将使用 CPU 推理；如需提速，请安装匹配 CUDA 的 PyTorch。

- 截图失败（PIL ImageGrab）  
  Windows 可能需要管理员权限；多显示器环境下请确保目标窗口位于主屏并处于前台。

- 键盘热键无法注册  
  仅在启用热键服务时需要；以管理员身份启动终端，或改用 GUI 的“一键截图”功能。

## 十、目录参考

详见“演示文档.md”的“雀宝の架构”章节，或以下关键文件：
- 入口：main.py（启动 GUI）
- GUI：api_gui.py（流式输出、聊天、Markdown 样式）
- 识别：Mahjong_YOLO/test.py（加载 YOLO，生成 hand_str）
- 分析：analyzer.py（向听/听牌/打点与建议）
- 点数：cal_scores.py（翻符点数评估）
- 模型脚本：Mahjong_YOLO/scripts/*
